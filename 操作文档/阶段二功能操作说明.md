# 阶段二功能操作说明

## 概述

阶段二实现了完整的手动线段绘制和基于RANSAC的墙面拟合功能，为用户提供了从交互式线段绘制到自动墙面检测的完整工作流程。

## 功能模块

### 1. 交互式线段绘制工具

#### 1.1 基本操作

**启动线段绘制模式**
- 通过菜单：`墙面提取` → `基于线段的墙面拟合`
- 快捷键：`Ctrl+L`
- 工具栏：点击线段绘制按钮

**绘制单线段**
1. 在俯视图中点击鼠标左键设置起点
2. 移动鼠标到终点位置
3. 再次点击鼠标左键完成线段绘制
4. 线段将以蓝色显示在视图中

**绘制多段线（连续线段）**
1. 按住 `Shift` 键进入多段线模式
2. 点击设置第一个点
3. 继续点击添加更多点，形成连续的线段链
4. 按 `Enter` 键或双击完成多段线绘制
5. 按 `Esc` 键取消当前绘制

#### 1.2 线段选择和编辑

**选择线段**
- 单击线段进行选择，选中的线段会高亮显示（红色）
- 按住 `Ctrl` 键可多选线段
- `Ctrl+A` 全选所有线段

**编辑线段**
- 选中线段后按 `E` 键进入编辑模式
- 拖拽线段端点可修改线段位置和长度
- 按 `Enter` 确认编辑，`Esc` 取消编辑

**删除线段**
- 选中线段后按 `Delete` 键删除
- 支持批量删除多个选中的线段
- 系统会弹出确认对话框

**线段分割**
- 选中线段后按 `S` 键
- 在线段上点击分割点
- 线段将被分割为两段

#### 1.3 高级功能

**撤销/重做**
- `Ctrl+Z`：撤销上一步操作
- `Ctrl+Y`：重做操作

**线段信息查看**
- 右键点击线段查看详细信息
- 包括长度、角度、起终点坐标等

**数据保存和加载**
- `Ctrl+S`：保存线段数据到JSON文件
- `Ctrl+O`：从JSON文件加载线段数据
- 支持项目文件管理

### 2. RANSAC墙面拟合算法

#### 2.1 基于线段的墙面拟合

**操作步骤**
1. 首先使用线段绘制工具在俯视图中绘制墙面轮廓线段
2. 确保线段大致沿着墙面方向绘制
3. 点击 `基于线段的墙面拟合` 按钮或使用快捷键 `Ctrl+L`
4. 系统将显示进度对话框，显示拟合进度
5. 拟合完成后自动显示结果对话框

**算法参数**
- 最小内点数：默认50个点
- 距离阈值：默认0.1米
- 最大迭代次数：默认1000次
- 置信度：默认99%

#### 2.2 自动墙面拟合

**操作步骤**
1. 加载点云数据到系统中
2. 点击 `自动墙面拟合` 按钮或使用快捷键 `Ctrl+A`
3. 系统自动检测垂直平面并提取墙面
4. 查看拟合结果和统计信息

**适用场景**
- 点云数据质量较好的室内环境
- 墙面结构相对规整的建筑
- 需要快速批量处理的场景

### 3. 结果查看和分析

#### 3.1 进度监控

**进度对话框功能**
- 实时显示拟合进度百分比
- 显示当前处理状态
- 显示已用时间和预计剩余时间
- 支持取消操作（按 `Esc` 或点击取消按钮）
- 可展开查看详细处理日志

#### 3.2 结果分析

**墙面信息标签页**
- 显示检测到的所有墙面列表
- 包含墙面ID、起终点坐标、长度、高度、厚度、置信度
- 支持点击选择和高亮显示
- 可按各列排序

**平面信息标签页**
- 显示检测到的所有平面
- 包含平面法向量、距离、内点数、置信度
- 区分垂直平面和其他平面

**统计信息标签页**
- 通用统计：总点数、处理点数、墙面数量等
- 性能统计：处理时间、算法效率等
- 质量统计：平均墙面长度、总面积、平均置信度等

**处理日志标签页**
- 详细的处理过程记录
- 包含时间戳和操作描述
- 便于问题诊断和性能分析

#### 3.3 数据导出

**支持格式**
- JSON格式：包含完整的墙面和平面信息
- CSV格式：表格形式，便于Excel处理
- 自定义格式：可根据需要扩展

**导出操作**
1. 在结果对话框中点击 `导出结果` 按钮
2. 选择保存位置和文件格式
3. 系统自动生成带时间戳的文件名
4. 确认导出完成

### 4. 用户界面集成

#### 4.1 菜单系统

**墙面提取菜单**
- 基于线段的墙面拟合 (Ctrl+L)
- 自动墙面拟合 (Ctrl+A)
- 取消拟合 (Esc)
- 清除所有数据 (Ctrl+Shift+C)
- 导出墙面数据 (Ctrl+E)
- 导入墙面数据 (Ctrl+I)
- 墙面拟合帮助 (F1)
- 关于墙面拟合

#### 4.2 工具栏

**快速访问按钮**
- 基于线段拟合按钮
- 自动拟合按钮
- 取消操作按钮
- 清除数据按钮
- 导入导出按钮

#### 4.3 状态栏

**实时信息显示**
- 当前操作状态
- 进度条（处理过程中）
- 点云点数统计
- 检测到的墙面数量

### 5. 快捷键参考

| 快捷键 | 功能 |
|--------|------|
| Ctrl+L | 基于线段的墙面拟合 |
| Ctrl+A | 自动墙面拟合 |
| Esc | 取消当前操作 |
| Ctrl+Shift+C | 清除所有数据 |
| Ctrl+E | 导出墙面数据 |
| Ctrl+I | 导入墙面数据 |
| F1 | 显示帮助信息 |
| Delete | 删除选中线段 |
| Ctrl+Z | 撤销操作 |
| Ctrl+Y | 重做操作 |
| Ctrl+S | 保存线段数据 |
| Ctrl+O | 加载线段数据 |
| E | 编辑选中线段 |
| S | 分割选中线段 |
| Shift+点击 | 多段线绘制模式 |

### 6. 常见问题和解决方案

#### 6.1 线段绘制问题

**问题：无法绘制线段**
- 检查是否正确进入线段绘制模式
- 确认鼠标点击在有效的俯视图区域内
- 检查点云数据是否正确加载

**问题：线段显示不清楚**
- 调整俯视图的缩放级别
- 检查线段颜色设置
- 确认视图渲染设置正确

#### 6.2 墙面拟合问题

**问题：拟合结果不理想**
- 检查线段绘制是否准确沿着墙面方向
- 调整RANSAC算法参数
- 确认点云数据质量和密度

**问题：处理速度慢**
- 减少点云数据量或使用LOD功能
- 调整算法参数减少迭代次数
- 检查系统资源使用情况

#### 6.3 数据导入导出问题

**问题：无法保存数据**
- 检查文件路径权限
- 确认磁盘空间充足
- 验证文件格式正确性

**问题：加载数据失败**
- 检查文件格式是否正确
- 验证JSON文件语法
- 确认文件版本兼容性

### 7. 性能优化建议

#### 7.1 大数据量处理

- 使用LOD（细节层次）功能减少渲染负担
- 启用空间索引加速查询
- 分块处理大型点云数据

#### 7.2 算法参数调优

- 根据点云密度调整距离阈值
- 根据数据质量调整最小内点数
- 根据精度要求调整迭代次数

#### 7.3 内存管理

- 及时清理不需要的数据
- 使用渐进式加载大文件
- 监控内存使用情况

## 总结

阶段二功能提供了完整的手动线段绘制和墙面拟合解决方案，支持从交互式绘制到自动检测的多种工作模式。通过直观的用户界面和强大的算法支持，用户可以高效地完成室内墙面的提取和分析工作。

建议用户根据具体应用场景选择合适的操作模式，并根据数据特点调整相关参数以获得最佳效果。
